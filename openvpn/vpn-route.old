#!/bin/bash
## vpn-route - v1.0
## Function: Set routing for OpenVPN network

## Installation:
## Add a new table ($IPTABLE) in /etc/iproute2/rt_tables (e.g. echo "200 torrent" >> /etc/iproute2/rt_tables)
## Add settings to OpenVPN config:
## route-noexec
## route-up /path/to/this-script

#echo "$dev: $ifconfig_local mask: $ifconfig_netmask gw: $route_vpn_gateway"

#Settings
VPNIF=$dev
MASK="0.0.0.0"
VPNGW=$route_vpn_gateway
IPTABLE="torrent"
LANGW="172.24.1.1"
LANNET="172.24.1.0/24"
#/Settings

if [[ -z "$VPNIF" ]]; then
  echo "Error: No VPN interface"
  exit 1
fi

if [[ -z "$MASK" ]]; then
  echo "Error: No VPN mask"
  exit 1
fi

if [[ -z "$VPNGW" ]]; then
  echo "Error: No VPN gateway"
  exit 1
fi

if [[ `ip rule list | grep -c $VPNGW` == 0 ]]; then
  #Add ip rule for VPN traffic to use $IPTABLE table
  ip rule add from $VPNGW/0.0.0.0 table $IPTABLE
fi

#Set default route to $VPNGW in $IPTABLE table
ip route replace default via $VPNGW dev $VPNIF table $IPTABLE
#Add routing for lo
ip route append default via 127.0.0.1 dev lo table $IPTABLE
#Add routing for $LANNET via $LANGW
ip route add $LANNET via $LANGW table $IPTABLE

#Commit changes
ip route flush cache
